#!/bin/sh

if [ -z "$BUILDERCONF" ]; then
    export BUILDERCONF="example-configs/debian.conf"
fi
echo "BUILDERCONF set to: ${BUILDERCONF}"

# Some basic tests
make clean || exit 1
make mostlyclean || exit 1
make clean-all || exit 1
make build-depends || exit 1

# Lets be sure we can build all base systems
DISTS_VM="wheezy jessie fc20"
make get-sources || exit 1
make build || exit 1
DISTS_VM=$DISTS_VM TEMPLATE_FLAVOR=$TEMPLATE_FLAVOR make template || exit 1

# Now lets try to also build whonix-gateway
DISTS_VM=wheezy
TEMPLATE_FLAVOR=whonix-gateway
DISTS_VM=$DISTS_VM TEMPLATE_FLAVOR=$TEMPLATE_FLAVOR make template || exit 1

# Run this on dom0 to transfer a script that will be able to grab and install all the built templates
# (keep script on dom0 for future grabs)
#
# Note to others: 
# ---------------
# Read last line of script located in 'qubes-src/linux-template-builder/rpm/install-templates.sh' 
# as it will contain the proper path and AppVM name
qvm-run --pass-io <APPVM> 'cat /home/user/qubes-builder/qubes-src/linux-template-builder/rpm/install-templates.sh' > install-templates.sh
